<!DOCTYPE html>
<html>
<head>
	<title>Displayer</title>
    <link rel=”stylesheet” href=”https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css”/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
	<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
	<script src="https://d3js.org/d3.v7.min.js"></script>
	<script type="text/javascript" src="https://code.jquery.com/jquery-1.7.1.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/js/ion.rangeSlider.min.js"></script>
	<style type="text/css">
    	#map {
			height: 100%;
		}

		html,
		body {
			height: 100%;
			margin: 0;
			padding: 0;
			background-color: #202124;
			color: white;
		}

		@media screen and (-webkit-min-device-pixel-ratio:0) {
		    input[type='range'] {
		      overflow: hidden;
		      width: 80%;
		      -webkit-appearance: none;
		    }
		    
		    input[type='range']::-webkit-slider-runnable-track {
		      height: 10px;
		      -webkit-appearance: none;
		      color: #13bba4;
		      margin-top: -1px;
		    }
		    
		    input[type='range']::-webkit-slider-thumb {
		      width: 10px;
		      -webkit-appearance: none;
		      height: 10px;
		      cursor: ew-resize;
		      background: #a8a8a8;
		      box-shadow: -300px 0 0 300px #43e5f7;
		    }
		}
		input[type="range"]::-moz-range-progress {
		  background-color: #13bba4; 
		}
		input[type="range"]::-moz-range-track {  
		  background-color: #9a905d;
		}
    </style>
</head>
<body>
	<table style="height: 100%; width: 100%;">
		<tr>
			<td style="width: 75%; height: 100%;">
				<div id="map"></div>
			</td>
			<td>
				<table id="content" style="height: 100%; width: 100%;">
					<tr style="height: 2%;"><td></td></tr>
					<tr style="height: 8%; width: 100%; "><td>
						<table style="height: 100%; width: 100%; ">
							<tr>
								<td style="text-align: center; width: 5%;">
									<button class="btn btn-primary" type="button" onclick="playSlideShow()" style="color: #202124; background-color: #13bba4 !important; border-color: #202124">
										<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#202124" class="bi bi-play" viewBox="0 0 16 16">
			 								<path d="M10.804 8 5 4.633v6.734L10.804 8zm.792-.696a.802.802 0 0 1 0 1.392l-6.363 3.692C4.713 12.69 4 12.345 4 11.692V4.308c0-.653.713-.998 1.233-.696l6.363 3.692z"/>
										</svg>
									</button>
								</td>
								<td style="text-align: center; width: 5%;">
									<button class="btn btn-primary" type="button" onclick="stopSlideShow()" style="color: #202124; background-color: #13bba4 !important; border-color: #202124">
										<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pause" viewBox="0 0 16 16">
										  <path d="M6 3.5a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5zm4 0a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5z"/>
										</svg>
									</button>
								</td>
								<td style="text-align: center; ">
									<input type="range" min="{{ first_date_time }}" max="{{ last_date_time }}" value="{{ first_date_time }}" class="slider" id="date" style="width: 80%; background-color: #202124;">
								</td>
							</tr>
							<tr>
								<td></td><td></td>
								<td style="text-align: center; "><p><output id="sliderAmount"></output></p></td>
							</tr>
						</table>
					</td></tr>
					<tr style="height: 90%;"><td>
						<img id="image" style="width: 100%;">
						<p id="imageDate"></p>
					</td></tr>
				</table>
			</td>
		</tr>
	</table>
	
</body>
</html>
<script>
	var options = { year: 'numeric', month: 'numeric', day: 'numeric' };
	var slideShowStatus = false;

	{% for image in images %}
	var marker{{ image.id }}; 
	{% endfor %}
	function initMap() {
	  	const map = new google.maps.Map(document.getElementById("map"), {
	    	zoom: 8,
	    	center: { lat: 47.36667, lng: 8.55 },
	    	mapTypeId: "satellite",
		});

	  	var travelCoordinates = [];
	{% for image in images %}
		travelCoordinates.push({
			lat: {{ image.latitude_deg }}, 
			lng: {{ image.longitude_deg}},
		});

		marker{{ image.id }} = new google.maps.Marker({
			position: {lat: {{ image.latitude_deg }}, lng: {{ image.longitude_deg}} },
			map,
			title: "{{ image.path }}".replaceAll("slash", "/"),
		});

		marker{{ image.id }}.addListener("click", () => {
			document.getElementById("image").src = "assets/{{ image.path }}";
			document.getElementById("imageDate").innerHTML = "(" + (new Date({{ image.image_date_time_naive.timestamp() }}*1000)).toLocaleDateString("en-US", options) + ")";
	    });

	{% endfor %}
		console.log(travelCoordinates);
		const travelPath = new google.maps.Polyline({
			path: travelCoordinates,
			geodesic: true,
		    strokeColor: "#FF0000",
		    strokeOpacity: 0.8,
		    strokeWeight: 3,
		});
		travelPath.setMap(map);
	}


	var slider = document.getElementById("date");

	slider.addEventListener('input', sliderChanged, false);

	function playSlideShow() {
		slideShowStatus = true;
		setInterval(function(){
		    if (!slideShowStatus || {{ last_date_time }} == parseInt(slider.value)) {
		    	return;
		    }
		    document.getElementById('date').value = parseInt(document.getElementById('date').value) + 3600;
		    sliderChanged();
		}, 100);
	}
	function stopSlideShow() {
		slideShowStatus = false;
	}

	function sliderChanged() {
		var distance = Number.MAX_SAFE_INTEGER;
		var imagePath = "";
		var timestamp = 0;
	{% for image in images %}
		if ({{ image.image_date_time_naive.timestamp() }} >= parseInt(slider.value) - {{ delta.num_seconds() }} && 
			{{ image.image_date_time_naive.timestamp() }} <= parseInt(slider.value) + {{ delta.num_seconds() }}) {
			if (distance > Math.abs({{ image.image_date_time_naive.timestamp() }} - parseInt(slider.value))) {
				distance = Math.abs({{ image.image_date_time_naive.timestamp() }} - parseInt(slider.value));
				imagePath = "assets/{{ image.path }}";
				timestamp = {{ image.image_date_time_naive.timestamp() }}
			}
			marker{{ image.id }}.setVisible(true);
		} else {
			marker{{ image.id }}.setVisible(false);
		}
	{% endfor %}
		document.getElementById("image").src = imagePath;
		document.getElementById("imageDate").innerHTML = "(" + (new Date(timestamp*1000)).toLocaleDateString("en-US", options) + ")";
        var sliderDiv = document.getElementById("sliderAmount");
        sliderDiv.innerHTML = "Center: " + (new Date(parseInt(slider.value)*1000)).toLocaleDateString("en-US", options);
	}
</script>
<script 
	async
	src="https://maps.googleapis.com/maps/api/js?key={ api key }&callback=initMap"
    defer
></script>